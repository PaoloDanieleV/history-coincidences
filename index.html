<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Historical Figures Journey Map</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { margin:0; font-family:Arial,Helvetica,sans-serif; background:#f4f4f4; }
    h1 { text-align:center; margin:15px 0; color:#222; font-size:1.6em; }
    #map { height:70vh; width:100%; }
    .controls { padding:12px; text-align:center; background:#fff; }
    #yearLabel { font-weight:bold; font-size:1.3em; color:#d00; }
    #alert { text-align:center; padding:8px; background:#ffeb3b; display:none; margin:5px 0; font-weight:bold; }
    .note { font-size:0.9em; margin:8px 0; color:#555; }
    .legend { display:flex; flex-wrap:wrap; justify-content:center; gap:10px; margin:10px; }
    .legend-item { display:flex; align-items:center; gap:5px; font-size:0.9em; }
    .legend-color { width:12px; height:12px; border-radius:50%; }
    /* Remove country borders & labels */
    .map-tiles {
      filter: 
        brightness(1.1) 
        contrast(1.1) 
        saturate(0.8)
        url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='1' height='1'><filter id='remove-borders'><feComponentTransfer><feFuncA type='table' tableValues='0 0'/></feComponentTransfer></filter></svg>#remove-borders");
    }
    
    /* Optional: Soften roads, keep cities */
    .leaflet-tile {
      border: none !important;
    }
      </style>
</head>
<body>

  <h1>Historical Figures Journey Map</h1>
  <div id="alert"></div>
  <div id="map"></div>

  <div class="controls">
    <input type="range" id="yearSlider" min="1800" max="2025" value="1913" step="1" style="width:80%;" />
    <div>Year: <span id="yearLabel">1913</span></div>
    <p class="note">Slide to follow journeys. Zoom & pan manually — no auto-jump!</p>
  </div>

  <div class="legend" id="legend"></div>

  <!-- Leaflet + PapaParse -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    // ========== MAP SETUP (FULL ZOOM/PAN ENABLED) ==========
    const map = L.map('map', {
      center: [48.2082, 16.3738],
      zoom: 6,
      zoomControl: true,           // Show + / - buttons
      doubleClickZoom: true,
      scrollWheelZoom: true,
      touchZoom: true,
      dragging: true               // Allow panning
    });

    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap',
      maxZoom: 18,
      className: 'map-tiles'
    }).addTo(map);

    const markers = L.layerGroup().addTo(map);
    const paths = L.layerGroup().addTo(map);
    const alertDiv = document.getElementById('alert');
    const legendDiv = document.getElementById('legend');

    // ========== COLOR PALETTE ==========
    const personColors = {};
    const colorPalette = ['#d00','#00a','#080','#d0a','#0aa','#a60','#a0a','#06d','#c50','#09d'];
    let colorIndex = 0;
    function getColor(name) {
      if (!personColors[name]) {
        personColors[name] = colorPalette[colorIndex % colorPalette.length];
        colorIndex++;
      }
      return personColors[name];
    }

    // ========== LOAD DATA ==========
    const sheetURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRhGNH694n31wex_-fz1QS3VBN6j6Iv_2fPMzAnMlXJlov2T2YmLTrGUmOjcKJgusy3348TOFMJYYdw/pub?output=csv";  // PASTE YOUR CSV LINK

    let rawData = [];

    Papa.parse(sheetURL, {
      download: true,
      header: true,
      complete: function(results) {
        rawData = results.data.filter(r => r.Name && r.Year && r.Lat && r.Long);
        buildLegend();
        updateMap(parseInt(document.getElementById('yearSlider').value));
      }
    });

    // ========== LEGEND ==========
    function buildLegend() {
      const names = [...new Set(rawData.map(r => r.Name.trim()))];
      legendDiv.innerHTML = names.map(name => `
        <div class="legend-item">
          <div class="legend-color" style="background:${getColor(name)}"></div>
          <span>${name}</span>
        </div>
      `).join('');
    }

    // ========== SLIDER ==========
    const slider = document.getElementById('yearSlider');
    const yearLabel = document.getElementById('yearLabel');

    slider.oninput = function () {
      const y = parseInt(this.value);
      yearLabel.textContent = y;
      updateMap(y);
    };

    // ========== UPDATE MAP (NO AUTO-ZOOM) ==========
    function updateMap(selectedYear) {
      markers.clearLayers();
      paths.clearLayers();

      const people = {};
      rawData.forEach(row => {
        const name = row.Name.trim();
        if (!people[name]) people[name] = [];
        people[name].push({
          year: parseInt(row.Year),
          lat: parseFloat(row.Lat),
          lng: parseFloat(row.Long),
          bio: row.Bio || '',
          source: row.Source || '#'
        });
      });

      const visible = [];
      const pathPoints = {};

      Object.keys(people).forEach(name => {
        const timeline = people[name].sort((a,b) => a.year - b.year);
        let current = null;

        for (let i = 0; i < timeline.length; i++) {
          const p = timeline[i];
          if (p.year === selectedYear) { current = p; break; }
          if (p.year < selectedYear && (!timeline[i+1] || timeline[i+1].year > selectedYear)) {
            current = p;
            break;
          }
        }

        if (current) {
          visible.push({ name, ...current });
        }
      });

      // --- Draw MOVEMENT LINE only in the year of change ---
      Object.keys(people).forEach(name => {
        const timeline = people[name].sort((a,b) => a.year - b.year);
        const current = timeline.find(p => p.year === selectedYear);
        const previous = timeline.slice().reverse().find(p => p.year < selectedYear);

        if (current && previous) {
          // Only draw if location actually changed
          const latDiff = Math.abs(current.lat - previous.lat);
          const lngDiff = Math.abs(current.lng - previous.lng);
          if (latDiff > 0.001 || lngDiff > 0.001) {
            L.polyline(
              [[previous.lat, previous.lng], [current.lat, current.lng]],
              {
                color: getColor(name),
                weight: 5,
                opacity: 1.0
              }
            ).addTo(paths);
          }
        }
      });

      // --- Add markers ---
      visible.forEach(p => {
        L.circleMarker([p.lat, p.lng], {
          radius: 10,
          color: '#fff',
          weight: 2,
          fillColor: getColor(p.name),
          fillOpacity: 0.9
        }).bindPopup(`
          <b style="color:${getColor(p.name)}">${p.name}</b> (${selectedYear})<br>
          ${p.bio}<br>
          <a href="${p.source}" target="_blank">Source</a>
        `).addTo(markers);
      });

      // --- Coincidence alert ---
      if (visible.length > 1) {
        alertDiv.style.display = 'block';
        alertDiv.textContent = `Coincidence! ${visible.length} figures in ${selectedYear}`;
      } else {
        alertDiv.style.display = 'none';
      }

      // NO AUTO-ZOOM — YOU CONTROL THE VIEW
    }
  </script>
</body>
</html>
